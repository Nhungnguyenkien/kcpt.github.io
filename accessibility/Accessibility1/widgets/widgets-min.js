Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{value:function(e,t){function n(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}if(null===this)throw new TypeError('"this" is null or not defined');var a=Object(this),o=a.length>>>0;if(0===o)return!1;for(var i=0|t,l=Math.max(i>=0?i:o-Math.abs(i),0);o>l;){if(n(a[l],e))return!0;l++}return!1}}),String.prototype.endsWith||Object.defineProperty(String.prototype,"endsWith",{value:function(e,t){return(void 0===t||t>this.length)&&(t=this.length),this.substring(t-e.length,t)===e}}),String.prototype.includes||(String.prototype.includes=function(e,t){return"number"!=typeof t&&(t=0),t+e.length>this.length?!1:-1!==this.indexOf(e,t)});var PREF=function(){function e(e,t,n){for(var a,o=parseInt(n.metadata.id,10),l=n.document.getAuthorPreference((t+e).toLowerCase()),r="all"===l[0]||"true"===l[0]||l.includes(o),s=0;s<i.length;s++)a=i[s],a.category===e||"all"===a.category?"all"===a.name||a.name.includes(t)?a.sketches.includes(n.anchorNode.context.id)||"all"===a.sketches[0]?r=!a.pages||"all"===a.pages[0]||a.pages.includes(o):"none"===a.sketches[0]&&(r=!1):"none"===a.name&&(r=!1):"none"===a.category&&(r=!1);return r}function t(e){var t,n;if("string"!=typeof e)return"object"==typeof e&&e.length>0&&"number"==typeof e[0]?e:["all"];if(e=e.toLowerCase(),"all"===e||"true"===e)return["all"];if(""===e||"none"===e||"false"===e)return["none"];for(t=e.split(","),n=0;n<t.length;n+=1)t[n]=parseInt(t[n],10);return t}function n(e){var t,n;if("string"!=typeof e)return["all"];if("all"===e||""===e)return["all"];if("none"===e)return["none"];for(t=e.split(","),n=0;n<t.length;n+=1)t[n]=t[n].trim();return t}function a(e,a,o,i){try{this.category=e.toLowerCase(),["widget","util","none","all"].includes(this.category)||GSP.createError("bad category to WSPPref constructor"),this.name=a.toLowerCase(),["style","visibility","label","upload","download","none","all"].includes(this.name)||GSP.createError("bad name to WSPPref constructor"),i?this.pages=t(i):this.pages=["all"],o?this.sketches=n(o):this.sketches=["all"]}catch(e){throw GSP.createError("bad arguments to WSPPref constructor")}}function o(e){var t,n;if(e.constructor===Array)for(var o=0;o<e.length;o++){var l=e[o];t=l.category?l.category:"all",n=l.name?l.name:"all",l.widget&&(t="widget",n=l.widget),i.push(new a(t,n,l.sketches,l.pages))}}var i=[];return{setWebPagePrefs:function(e){o(e)},shouldEnable:function(t,n,a){return e(t,n,a)}}}(),WIDGETS=function(){function e(e,t){return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t.prototype}function t(){return J?Y.data("document").sQuery.sketch:void 0}function n(e){return $(e).closest(".sketch_canvas")[0]}function a(e){this.name=e,this.domButtonSelector="#widget_"+e+"ButtonID",this.enabled=!0}function o(e){a.call(this,e)}function i(){H.tinyDraggable({exclude:".dragExclude"}),H.toggle(!0),$(".widget_button").removeClass("widget_button_active"),Y.parent().find(".widget_button").addClass("widget_button_active")}function l(){H&&H.toggle(!1),$(".widget_button").removeClass("widget_button_active")}function r(e,a){var o=n(e),r=$(o),s=r.data("document"),c=s.sQuery.sketch;if(!r.is(":hidden")&&c!==X){var d=!1;if(be.forEach(function(e){e.shouldEnableForCurrentPage(c)&&(d=!0)}),!d)return J&&o!==J||(ee||(ee=Z),Z&&Z.deactivate(),l()),!1;if(Z&&(ee=Z,Z.deactivate()),be.forEach(function(e){e.setEnablingForCurrentPage(c,e)}),o!==J||a){J&&(Y.off("WillPlayTool.WSP"),Y.off("ToolPlayed.WSP"),Y.off("ToolAborted.WSP")),J=o,Y=$(J),X=c;var u=$("<div style='position: relative; height:0; width:"+r.width()+"px;'></div>");r.prepend(u),H.appendTo(u),H.css({top:r.height()-H.height(),left:-24}),Y.on("WillPlayTool.WSP",function(){$("#widget").css({opacity:.25,"z-index":-1}),Z&&(ee=Z,WIDGETS.confirmModality())}),Y.on("ToolPlayed.WSP",function(){$("#widget").css({opacity:1,"z-index":"none"}),ee&&ee.activate(t())}),Y.on("ToolAborted.WSP",function(){$("#widget").css({opacity:1,"z-index":"none"})})}return pe.setVisColor(c),ee&&ee.enabled&&ee.activate(c,ee),ee=null,i(),d}}function s(e){t()!==e&&r(e.canvasNode[0]),t()===e&&Z&&Z.preProcessGobj&&!Z.skipProcessing&&(e.sQuery("*").each(Z.preProcessGobj),e.isDirty=!0,e.setNeedsDisplay())}function c(e,t){return s(t.sketch),!0}function d(){return Z&&Z.postProcessSketch(t()),!0}function u(){return parseFloat(getComputedStyle($("#widget")[0]).fontSize)/16}function f(e,t){e.checked=t,e.src=t?V+"/checked.png":V+"/unchecked.png"}function p(e){return e.checked=e.checked?!1:!0,e.src=e.checked?V+"/checked.png":V+"/unchecked.png",e.checked}function h(e){r(e.canvasNode[0],!0);var t=e.canvasNode[0],n=J===t&&"none"!==H[0].style.display,a=t.parentNode,o=$(a).find(".widget_button");n?o.show():o.hide()}function g(){Z&&(ee=Z,Z.deactivate())}function b(e){var t,n=e.parentNode,a=$(n).find(".widget_button");1===a.length&&(t='<button class="widget_button" onclick="WIDGETS.toggleWidgets(this);">Widgets</button>',a.replaceWith(t))}function m(e){var t,n,a,o;t=e.canvasNode,n=t.parent(),n.hasClass("sketch_container")&&(a=t.find(".wsp-base-node"),a||(a=t),o=a[0].getBoundingClientRect(),n.css("width",o.width+"px"))}function y(e){q&&q&&q!==e&&(q.setRenderState("none"),q=null),e&&(q=e,q.setRenderState(te))}function v(e){var t,n=!1,a=q,o=a.sQuery.sketch;return a?((a.isOfKind("Button")||a.isOfKind("Text"))&&(a.isOfKind("Text")?(n=a.style.color!==e,n&&(a.style.color=e)):a.isOfKind("Button")&&(n=a.style.label.color!==e,n&&(a.style.label.color=e)),t=Y.find("[wsp-id='"+a.id+"']"),t[0]&&(t.css({color:e}),t.find("*").css({color:e}))),!n&&a.style.label&&a.style.label.showLabel&&(n=a.style.label.color!==e,n&&(a.style.label.color=e,a.needsRenderInit=!0,o.renderPrepare(),a.invalidateAppearance())),n):!1}function P(){var e,t,n=q;n.oldStyle&&(n.isOfKind("Button")||n.isOfKind("Text")?(e=n.isOfKind("Text")?n.oldStyle.color:n.oldStyle.label.color,t=n.isOfKind("Text")?n.style.color:n.style.label.color):n.style.label&&n.style.label.showLabel&&(e=n.oldStyle.label.color,t=n.style.label.color)),e&&t!==e&&v(e)}function w(){var e,t=Math.floor(le/3);switch(le-3*t){case 0:e="a";break;case 1:e="b";break;case 2:e="c"}return $(".block"+t+e).css("background-color")}function S(e){var t=!1,n=q;return n&&fe.objectColorBox.checked&&(n.isOfKind("Text")?t=v(e):(n.setRenderState("none"),t=n.style.color!==e,t&&(n.style.color=e,n.invalidateAppearance()),n.setRenderState(te))),t}function k(e){var t=q;ae=e,t&&t.style.radius&&ae>=0&&(t.setRenderState("none"),t.style.radius=re[ae],t.setRenderState(te),t.invalidateAppearance())}function L(e,t){var n=q;ie=e,oe=t,n&&(n.setRenderState("none"),n.isOfGenus("Path")&&ie>=0&&(n.style["line-style"]=se[ie]),n.style.width&&oe>=0&&(n.style.width=ce[oe]),n.setRenderState(te),n.invalidateAppearance())}function C(e){var t=w(e);fe.objectColorBox.checked&&S(t),fe.textColorBox.checked&&v(t)}function O(e,t){var n=$("#lineStyleCheckbox")[0],a=$("#widget_lineStyleSelector")[0].style;if(0>e&&0>t)f(n,!1),a.display="none";else{fe.defaultLineThickness=e,fe.defaultLineStyle=t,f(n,!0);var o=1.25*e+1.31,i=3.2*t+.31;a.top=o+"rem",a.left=i+"rem",a.display="block"}L(t,e)}function T(e){var t=$("#pointStyleCheckbox")[0],n=$("#pointStyleSelector")[0].style;if(0>e)f(t,!1),n.display="none";else{fe.defaultPointStyle=e,f(t,!0);var a=1.25*e+1.31;n.top=a+"rem",n.display="block"}k(e)}function x(e,t){var n=$("#widget_colorSelector")[0].style;0>e?(n.display="none",f(fe.objectColorBox,!1),f(fe.textColorBox,!1),le=-1):(le=3*e+t,n.top=1.56*t+.13+"rem",n.left=1.69*e+.1+"rem",n.display="block",fe.defaultColor={row:t,column:e},fe.textColorBox.checked||f(fe.objectColorBox,!0),q&&C(le))}function E(){t().labelPool.saveState(),he.labelPoolSaved=!0}function F(){he.labelPoolSaved&&(t().labelPool.restoreSavedState(),he.labelPoolSaved=!1)}function B(){he.labelPoolSaved&&(q.sQuery.sketch.labelPool.forgetSavedState(),he.labelPoolSaved=!1)}function j(e){var t=he.inputElt;"string"==typeof e&&t.val(e),t.focus(),t[0].setSelectionRange(0,t.val().length)}function R(e){var n;E(),n=t().labelPool.generateLabel(e.kind,e.genus),e.hasLabel?e.setLabel(n,{showLabel:!0,wasUserInitiated:!0}):e.label=n,j(n)}function W(e){var t=e.sQuery.sketch,n=I(e),a=n["font-family"];return"number"==typeof a&&(a>=t.document.resources.fontList.length&&(a=0),a=t.document.resources.fontList[a],n["font-family"]=a),a}function _(e){var t="";return e.genus.includes("Measure")?t="measure":e.genus.includes("Parameter")?t="param":e.useTransformLabel()&&(t="transImage"),t}function G(e){var t,n,a=Y.find("[wsp-id='"+e.id+"']"),o=I(e)["font-family"],i=I(e)["font-size"],l=e.sQuery.sketch,r=l.renderRefCon,s=e.hasLabel?r.label[e.id]:r.gobj[e.id];e.parsedMFS=null,e.hasLabel?(D(s,"invalidateLabel passed a labeled gobj with no renderRefCon.label"),s["font-family"]=o,s["font-size"]=i,n=r.labelBounds[e.id],n&&l.invalidateRect(n),e.state.labelPreRenderJITPrepareDone=!1,e.labelPreRenderJITPrepare(l.dcForGObjLabel(e,"normal"),l.renderRefCon.label[e.id])):(t=s.css,s=s.baseStyles,D(1===a.length,"invalidateLabel should find a single matching node."),t["font-family"]=o,t["font-size"]=i,s["font-family"]=o,s["font-size"]=i,a.css({"font-size":i,"font-family":o}),$(a).find('[style*="font-family"]').css("font-family",o),e.state.forceDomParse=!0,e.descendantLabelGraphHasChanged(),he.showLabelElt.prop("checked","noVisibleName"!==e.style.nameOrigin)),e.invalidateAppearance()}function N(e,t){function n(){D(!t,"A button or function shouldn't have a nameOrigin."),o.shouldAutogenerateLabel&&(o.shouldAutogenerateLabel=!1),i&&(e=" ",j(e)),o.label=e,o.messages&&(o.messages=[])}function a(){o.label=e,e=e.replace(/'/g,"\\'"),o.textMFS="<VL<T'"+e+"'>>"}var o=q,i=!e||""===e,l=void 0===o.style.nameOrigin||t===o.style.nameOrigin;return e||(e=""),q.label===e&&l?e:(i&&F(),t&&(o.style.nameOrigin=t),o.hasLabel?(o.shouldAutogenerateLabel=["namedByPrime","namedByShortFn","namedByFullFn","namedFromTemplate"].includes(t),i&&(e=o.label),o.setLabel(e,{showLabel:!0}),e=o.label):o.isOfKind("Button")||o.isOfGenus("Function")?n():"Caption"===o.genus?a():"namedFromLabel"===t&&(i?(R(o),e=o.label):o.label=e),G(o),e)}function D(e,t){e||t||(t="Unidentified error")}function M(e){var t=q,n={x:-5,y:+t.style.label["font-size"]},a=t.style.label.showLabel;void 0===e&&(t.hasLabel?e=!t.style.label.showLabel:he.nameClass&&t.style.nameOrigin&&(e="noVisibleName"!==t.style.nameOrigin)),t.hasLabel?(t.style.label.showLabel=e,e&&!a&&(t.isAPath()&&(t.labelRenderBounds||(t.labelRenderBounds=U(t.sQuery.sketch.renderRefCon.labelBounds[t.id])),he.isLabelTap&&(n.x=he.touchPos.x-t.labelRenderBounds.left-1,n.y=he.touchPos.y-t.labelRenderBounds.top-6)),t.setLabelPosition(he.touchPos,n))):he.nameClass&&t.style.nameOrigin&&LabelControls.labelChanged(e?t.label:""),he.showLabelElt.prop("checked",e),G(t)}function U(e,t){return t||(t={}),t.top=e.top,t.bottom=e.bottom,t.left=e.left,t.right=e.right,t}function I(e){var t=e.style.label;return(!t||$.isEmptyObject(t))&&(t=e.style),t}function K(e){var t,n=W(e);return t=n.substring(0,1),'"'===t||"'"===t?n=n.split(t)[1]:n.indexOf(",")&&(n=n.split(",")[0]),n}function A(){var e,t,n,a=$.makeArray($("script[src]"));for(e=0;e<a.length;e++)if(t=a[e],t.src&&t.src.endsWith("/widgets.js"))return n=t.src.split("?")[0].split("/").slice(0,-1).join("/")+"/"}function z(e){var t="",n="",a=he.inputElt[0],o=a.selectionStart,i=a.selectionEnd,l=a.value;o>0&&(t=l.slice(0,o)),i<l.length&&(n=l.slice(i)),l=t+e+n,WIDGETS.labelChanged(l),a.value=l,i=t.length+e.length,a.setSelectionRange(i,i)}function Q(e){return!(e.isOfKind("Text")||e.isOfKind("AngleMarker")||e.isOfKind("PathMarker")||e.isOfKind("Button")||e.isOfKind("CoordSys")||e.isOfKind("DOMKind")||e.isOfKind("IterateImage")||e.isOfKind("CoordSys")||e.isOfKind("DOMKind")||e.isOfKind("Map")||e.isOfKind("Picture"))}var V,H,J,Y,X,q,Z,ee,te="fadeInOut",ne=!0,ae=-1,oe=-1,ie=-1,le=-1,re=[1.5,2,4,6],se=["solid","dashed","dotted"],ce=[.5,1,3,5],de="#ddf",ue="#fff";a.prototype.activate=function(e,t){return Z&&Z!==t&&Z.deactivate(),e.document.isCurrentlyInToolplay()?!1:(Z=t,this.active=!0,this.sketch=e,$(t.domButtonSelector).css("background",de),!0)},a.prototype.deactivate=function(e){e===Z&&(Z=null),this.active=!1,this.sketch=null,$(e.domButtonSelector).css("background",ue)},a.prototype.toggle=function(e,t){this===Z?this.deactivate(t):this.activate(e,t)},a.prototype.shouldEnableForCurrentPage=function(e){var t;return t=PREF.shouldEnable("widget",this.name,e),"trace"===this.name&&(t=t&&e.preferences.tracesEnabled),t},a.prototype.setEnablingForCurrentPage=function(e,t){var n=this.shouldEnableForCurrentPage(e);return t.enabled=n,n?$(t.domButtonSelector).show():(this===Z&&t.deactivate(),$(t.domButtonSelector).hide()),n},e(o,a),o.prototype.preProcessGobj=function(e,t){t.style.selectable||(t.style.wasUnselectable=!0,t.style.selectable=!0,t.isOfKind("Button")&&t.invalidateAppearance())},o.prototype.postProcessGobj=function(e,t){t.style.wasUnselectable&&(t.style.selectable=!1,delete t.style.wasUnselectable,t.isOfKind("Button")&&t.invalidateAppearance())},o.prototype.activate=function(e,t){var n;return Object.getPrototypeOf(this).activate(e,t)?(n=$(".sketch_canvas"),n.on("Tap.WSP",t.handleTap),n.on("WillUndoRedo.WSP",d),n.on("UndoRedo.WSP",c),s(e),!0):!1},o.prototype.deactivate=function(e){var t=$(".sketch_canvas");t.off("Tap.WSP",e.handleTap),t.off("WillUndoRedo.WSP",d),t.off("UndoRedo.WSP",c),Z&&Z.postProcessSketch(this.sketch),Object.getPrototypeOf(this).deactivate(e)},o.prototype.handleTap=function(e,t){var a=n(t.document.canvasNode[0]);return a===J||r(a)?t.gobj:null};var fe=new o("style");fe.cancelOnExit=!1,fe.defaultColor={row:0,column:1},fe.defaultPointStyle=2,fe.defaultLineThickness=2,fe.defaultLineStyle=0;var pe=new o("visibility"),he=new o("label");he.labelPoolSaved=!1,he.touchPos=GSP.GeometricPoint(0,0),he.textRule=null;var ge=new o("trace"),be=[fe,pe,he,ge];return o.prototype.postProcessSketch=function(e){return Z&&Z.postProcessGobj&&!Z.skipProcessing&&(e.sQuery("*").each(Z.postProcessGobj),e.isDirty=!0),!0},fe.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,$("#wStylePane").css("display","block"),!0):!1},fe.deactivate=function(){Object.getPrototypeOf(this).deactivate(this),$("#wStylePane").css("display","none"),this.cancelOnExit=!1,y(null)},fe.postProcessGobj=function(e,t){t.oldStyle&&(fe.cancelOnExit&&(t.style=jQuery.extend(!0,{},t.oldStyle),P(),t.sQuery.sketch.invalidateAppearance(t)),delete t.oldStyle),Object.getPrototypeOf(fe).postProcessGobj(e,t)},fe.handleTap=function(e,t){var n;n=Object.getPrototypeOf(fe).handleTap(e,t),n&&(y(n),n.oldStyle||(n.oldStyle=jQuery.extend(!0,{},n.style)),k(ae),L(ie,oe),le>=0&&C(le))},pe.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?!0:!1},pe.deactivate=function(){Object.getPrototypeOf(this).deactivate(this)},pe.preProcessGobj=function(e,t){var n=t.style;n.hidden&&(n.originalColor=n.color,n.color=pe.visColor,n.newHidden=!0,t.show()),Object.getPrototypeOf(pe).preProcessGobj(e,t)},pe.postProcessGobj=function(e,t){var n=t.style;n.originalColor&&(n.color=n.originalColor,delete n.originalColor,n.newHidden?t.hide():t.show(),delete n.newHidden),Object.getPrototypeOf(pe).postProcessGobj(e,t)},pe.handleTap=function(e,t){var n=Object.getPrototypeOf(pe).handleTap(e,t);if(n){var a=n.style;a.originalColor||(a.originalColor=a.color,a.newHidden=a.hidden),a.newHidden=!a.newHidden,a.newHidden?a.color=pe.visColor:a.color=a.originalColor,n.show()}},pe.setVisColor=function(e){var t="rgb(192,192,192)",n=e.preferences.colorableComponents.Background.color;if(n){var a=document.createElement("div");a.style.color=n;var o=window.getComputedStyle(a).color;if("rgb"===o.substring(0,3)){var i=o.split("(")[1].split(")")[0];i=i.split(","),t="rgb(";for(var l=0;3>l;l++)t+=i[l]<128?i[l]+64:i[l]-32,2>l&&(t+=",");t+=")"}}pe.visColor=t},he.cacheProperties=function(e){this.oldLabel="Caption"===e.genus?e.textMFS:e.label,W(e),this.oldStyle=$.extend(!0,{},e.style)},he.emptyCache=function(){this.oldLabel=null,this.oldStyle=null},he.clear=function(e){this.emptyCache(),B(),j(""),$("#measureButtons, #transImageButtons, #paramButtons").toggle(!1),e!==!1&&(he.sizeElt.val(""),he.fontElt.val(""),he.showLabelElt.prop("checked",!1))},he.finalizeLabel=function(){var e;q&&q.hasLabel&&q.style.nameOrigin&&(e=LabelControls.originFromText(q.label),e&&q.style.nameOrigin!==e&&(q.style.nameOrigin=e))},he.restoreLabel=function(e){e&&(e.style&&(e.style=$.extend(!0,{},he.oldStyle)),"Caption"===e.genus?(e.textMFS=he.oldLabel,delete e.label):(e.label=he.oldLabel?"":" ",N(he.oldLabel,e.style.nameOrigin)),F(),G(e)),this.emptyCache()},he.handleTap=function(e,t){function n(){function e(){function e(){function e(e){t=e.makeParentalLabel("namedByPrime","init"),n=e.makeParentalLabel("namedByShortFn","init"),a=e.makeParentalLabel("namedByFullFn","init")}var t,n,a;(r.isTransformationConstraint||r.state.labelParent)&&e(r),i[t]="namedByPrime",i[n]="namedByShortFn",i[a]="namedByFullFn",i["*"]=r.label?"namedFromLabel":"namedByPrime",o.namedByPrime=t,o.namedByShortFn=n,o.namedByFullFn=a,o.namedFromLabel=r.label?r.label:t,r.style.nameOrigin||(r.label?r.style.nameOrigin=i[r.label]||"namedFromLabel":(r.label=t,r.style.nameOrigin="namedByPrime"))}function t(){o={namedFromTemplate:"",noVisibleName:"",namedFromLabel:"*"},i={" ":"noVisibleName","*":"namedFromLabel"}}var n,a=he.nameClass,o={},i={};if(n=f&&_(d)===a?d:r,$(".wLabelRadios").toggle(!1),a){switch($("#"+a+"Buttons").toggle(!0),a){case"transImage":e(),he.handleTap&&n&&_(n)===a&&"namedFromLabel"!==n.style.nameOrigin&&(r.style.nameOrigin=n.style.nameOrigin);break;case"measure":case"param":t();break;default:console.log("Unknown nameClass: "+a)}LabelControls.init(a,q,WIDGETS.controlCallback,o,i,"#wLabelEditText","#"+a+"Buttons input[type='radio']","#wLabelShow")}else LabelControls.terminate()}function t(){var e=s.val();e&&he.setFontSize(e),e=c.val(),e&&he.setFont(e)}function n(e){var t,n=!1;for(t=0;t<c[0].length;t++)if(c[0][t].innerText===e){c[0].selectedIndex=t,n=!0;break}return n}function a(e,t){var n,a,o,i=$("#wLabelFont optgroup"),l="<option value='"+e+"'>"+t+"</option>",r=i.filter('[label="Sans Serif"]'),s=i.filter('[label="Serif"]'),d=i.filter('[label="Mono-spaced"]'),u=i.filter('[label="Other"]'),f=!1;for(a=e.search(/sans-serif/i)?r:e.search(/serif/i)?s:e.search(/monospace/i)?d:u.length?u:c.append('<optgroup label="Other"></optgroup>'),o=$(a).find("option"),n=0;n<o.length;n++)if(-1===t.localeCompare(o[n].innerText)){$(o[n]).before($(l)),f=!0;break}f||a.append(l)}function o(){var e=I(q),t=e["font-size"];if(s.val(t),c[0].selectedIndex=-1,t=K(q,!1),!t)throw GSP.createError("WIDGETS.copyGObjToStyles() found a gobj without a font family.");n(t)||(a(e["font-family"],t),n(t))}function i(e,t){var n;return n=e&&t&&e.hasLabel===t.hasLabel,n=n&&(t.hasLabel||e.kind===t.kind||e.isOfKind("Measure")&&t.isOfKind("Measure")),n=n&&(he.isLabelTap||!t.hasLabel||!t.style.label.showLabel)}function l(){var e,t=u.textMFS,n=t.match(/<T\'[^\'\r\n]+\'>/g),a="";for(e=0;e<n.length;e++)a&&(a+=" "),a+=n[e].replace(/<T\'([^\'\r\n]+)\'>/,"$1");return a}var r,d,f;"Caption"!==u.genus||u.label||(u.label=l()),u.hasLabel||u.style.nameOrigin?$("#wShowLabelButton label").show():$("#wShowLabelButton label").hide(),r=u,d=q,f=i(d,r),he.clear(!1),q&&q.setRenderState("none"),u.setRenderState("targetHighlit"),this.prevGobj=q,q=u,he.nameClass=_(q),he.cacheProperties(q),r.hasLabel&&!r.style.label.showLabel&&(r.labelRenderBounds=U(r.sQuery.sketch.renderRefCon.labelBounds[r.id]),r.setLabelPosition(he.touchPos,{x:0,y:0})),j(q.label),f?t():o(),e()}function a(){r.prop("disabled",!1),q.label||R(q),M(!0),r.prop("checked",!0)}function o(){var e=q.style.nameOrigin,t=q.isOfKind("Button"),n="measure"===he.nameClass||"param"===he.nameClass,a=t||"undefined"==typeof e,o=a||"namedFromLabel"===e;t?(r.prop("checked",o),r.prop("disabled",a)):n&&($("#wLabelPane .radio-inline input").prop("checked",!1),$("#wLabelPane .radio-inline input[value='"+e+"']").prop("checked",!0),r.prop("checked","noVisibleName"!==e),r.prop("disabled",!1))}function i(e){var t=e.match(/<VL<T\'.*\'>>/);return t||(t=e.match(/<T\'.*\'>/)),t?!0:!1}var l=he.inputElt,r=he.showLabelElt,s=he.sizeElt,c=he.fontElt,d=GSP.GeometricPoint(t.position.x,t.position.y),u=Object.getPrototypeOf(he).handleTap(e,t);if(he.touchPos=d,he.isLabelTap=t.isLabelTap,"Caption"!==u.genus||i(u.textMFS)){if($("#wLabelPrompt").css("display","none"),$("#wLabelPane").css("display","block"),u===q)return void(q.hasLabel&&(M(),j(q.label)));he.finalizeLabel(),n(),q.hasLabel?a():o(),l.on("keyup",function(e){if(e.stopPropagation(),13===e.keyCode)he.confirmLabel(!0);else{var t=l.val();t.length>0?N(t):q.isOfKind("Button")&&j(" ")}})}},he.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(this.cancelOnExit=!1,q=null,this.prevGobj=null,$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","block"),this.inputElt||(this.inputElt=$("#wLabelEditText"),this.showLabelElt=$("#wLabelShow"),this.sizeElt=$("#wLabelFontSize"),this.fontElt=$("#wLabelFont")),this.inputElt.on("click",function(){$(this).focus()}),this.clear(),!0):!1},he.deactivate=function(){q&&(q.setRenderState("none"),this.cancelOnExit&&this.restoreLabel(q)),this.clear(),Object.getPrototypeOf(this).deactivate(this),$("#wLabelContent").css("display","none"),$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","none"),this.cancelOnExit=!1},he.confirmLabel=function(e){this.finalizeLabel(),e?this.deactivate():this.clear()},he.setFontSize=function(e){var t=I(q);e=+e,t["font-size"]!==e&&(t["font-size"]=e,G(q))},he.setFont=function(e){var t=I(q),n=t["font-family"];n!==e&&(t["font-family"]=e,G(q))},he.postProcessSketch=function(e){he.clear(),$("#wLabelPane").css("display","none"),$("#wLabelPrompt").css("display","block"),q=null,Object.getPrototypeOf(he).postProcessSketch(e)},ge.changePaneOpen=function(){return"none"!==$("#wTracePrompt").css("display")},ge.toggleChangePane=function(){function e(e){l.dragStart={x:e.clientX,y:e.clientY}}function n(e,t){return Math.max(Math.abs(t.x-e.x),t.y-e.y)>5}function a(e){n(l.dragStart,{x:e.clientX,y:e.clientY})&&(l.postProcessSketch(i),l.dragging=!0)}var o=$("#wTracePrompt"),i=t(),l=this;"none"===o.css("display")?(o.css("display","block"),ge.skipProcessing=!1,s(i),Y.on("StartDrag.WSP",function(t,n){e(n.touch)}),Y.on("MoveDrag.WSP",function(e,t){a(t.touch)}),Y.on("EndDrag.WSP",function(){l.dragging&&(s(i),l.dragging=!1),l.dragStart=null})):(o.css("display","none"),l.postProcessSketch(i),ge.skipProcessing=!0,Y.off("StartDrag.WSP"),Y.off("MoveDrag.WSP"),Y.off("EndDrag.WSP"))},ge.toggleFading=function(){var e=t(),n=e.preferences,a=$("#wTraceFading")[0].checked;n.fadeTraces=a,a?(e.traces.fadeStartTime=Number(new Date),e.startFadeJob()):e.stopFadeJob()},ge.activate=function(e){return Object.getPrototypeOf(this).activate(e,this)?(ge.skipProcessing=!0,$("#wTracePrompt").css("display","none"),$("#wTraceEnabled").prop("checked",t().preferences.tracesEnabled),$("#wTraceFading").prop("checked",t().preferences.fadeTraces),this.cancelOnExit=!1,$("#wTracePane").css("display","block"),!0):!1},ge.deactivate=function(){ge.changePaneOpen()&&ge.toggleChangePane(),Object.getPrototypeOf(this).deactivate(this),$("#wTracePane").css("display","none"),this.cancelOnExit=!1},ge.preProcessGobj=function(e,t){t.style.traced&&t.setRenderState("unmatchedGiven"),Object.getPrototypeOf(ge).preProcessGobj(e,t)},ge.postProcessGobj=function(e,t){t.style.traced&&"unmatchedGiven"===t.state.renderState&&t.setRenderState("none"),Object.getPrototypeOf(ge).postProcessGobj(e,t)},ge.handleTap=function(e,n){var a,o=Object.getPrototypeOf(ge).handleTap(e,n);!ge.skipProcessing&&Q(o)&&o&&(a=o.style,a.traced=!a.traced,a.traced?(o.setRenderState("unmatchedGiven"),$("#wTraceEnabled").prop("checked",!0),t().preferences.tracesEnabled=!0):o.setRenderState("none"))},{initWidget:function(){V=A(),$.ajax({url:V+"widgets.html",success:function(e){var n;$("body").append(e),H=$("#widget"),$("#widget img").attr("src",function(e,t){var n=t.match(/[^\/]+$/);return V+n});var a=$(".sketch_canvas");a.on("LoadDocument.WSP",function(e,t){b(t.document.canvasNode[0]),m(t.document)}),a.on("UnloadDocument.WSP",function(e,n){Z&&t()===n.document.focusPage&&Z.deactivate()}),a.each(function(e,t){var a=$(t).data("document");b(t),a&&(m(a),n||(n=a))}),a.on("WillChangeCurrentPage.WSP",function(e,t){g(t.document)}),a.on("DidChangeCurrentPage.WSP",function(e,t){h(t.document)}),$(".wCharDropdownContent .column div").click(function(){z(this.innerText)}),n&&h(n),fe.objectColorBox=$("#objectColorCheckbox")[0],fe.textColorBox=$("#textColorCheckbox")[0],ne||H.css("display","none"),$("#wTraceEnabled").change(function(e){t().preferences.tracesEnabled=e.target.checked}),$("#wShowLabelButton label input").change(function(){M(he.showLabelElt.prop("checked"))})},dataType:"html"})},showWidgets:function(e,n){return H||e?(n&&r(n),void((J||!e)&&(e?(i(),ee&&(ee.activate(t(),ee),ee=null)):(Z&&(ee=Z,Z.deactivate()),l())))):void(ne=!1)},toggleWidgets:function(e){var t,n,a="none"===H.css("display"),o=".sketch_canvas";if(e){for(t=$(e),n=t.filter(o);t.length&&!n.length;)n=t.prevAll(o),t=t.parent();if(!n.length)throw GSP.createError("toggleWidgets called for an element that's neither a sketch_canvas nor a widget_button");n[0]!==J&&(a=!0)}return WIDGETS.showWidgets(a,n[0]),a},confirmModality:function(){Z&&(Z.cancelOnExit=!1,Z.deactivate())},cancelModality:function(){Z&&(Z.cancelOnExit=!0,Z.deactivate())},toggleStyleModality:function(){Z===fe?fe.deactivate(this):fe.activate(t(),fe)},toggleVisibilityModality:function(){Z===pe?pe.deactivate(pe):J&&Y.data("document")&&pe.activate(t(),pe)},toggleLabelModality:function(){Z===he?he.deactivate(he):J&&Y.data("document")&&he.activate(t(),he)},toggleTraceModality:function(){Z===ge?ge.deactivate(ge):J&&Y.data("document")&&ge.activate(t(),ge)},toggleTraceChangePane:function(){ge.toggleChangePane()},toggleTraceFading:function(){ge.toggleFading()},clearTraces:function(){t().clearTraces()},pointCheckClicked:function(){T(0>ae?fe.defaultPointStyle:-1)},pointGridClicked:function(e){var t=u();T(Math.floor(e.offsetY/(20*t)))},lineCheckClicked:function(){0>ie&&0>oe?O(fe.defaultLineThickness,fe.defaultLineStyle):O(-1,-1)},lineGridClicked:function(e){var t=u();O(Math.floor(e.offsetY/(20*t)),Math.floor(e.offsetX/(51*t)))},colorCheckClicked:function(){var e=p(fe.objectColorBox);e||fe.textColorBox.checked?0>le&&x(fe.defaultColor.column,fe.defaultColor.row):x(-1,0)},labelCheckClicked:function(){var e=p(fe.textColorBox);e||fe.objectColorBox.checked?0>le&&x(fe.defaultColor.column,fe.defaultColor.row):x(-1,0)},labelSetFontSize:function(e){q&&he.setFontSize(+e)},labelSetFont:function(e){q&&he.setFont(e)},colorGridClicked:function(e){var t=u(),n=e.pageX-$("#widget_colorGrid").offset().left,a=e.pageY-$("#widget_colorGrid").offset().top,o=Math.min(8,Math.floor(n/(27.2*t))),i=Math.floor(a/(27*t));x(o,i)},labelChanged:function(e){LabelControls.labelChanged(e)||N(e)},controlCallback:function(e,t){return e=N(e,t)},labelToggled:function(){M(he.showLabelElt.prop("checked"))},setWidgetsPrefs:function(e){PREF.setWebPagePrefs(e)},getScriptPath:function(){return V}}}(),LabelControls=function(){function e(e,t){var n={namedFromTemplate:a,namedFromLabel:o,noVisibleName:i},c={namedByPrime:l,namedByShortFn:r,namedByFullFn:s,namedFromLabel:o};switch(e){case"measure":case"param":return n[t];case"transImage":return c[t]}}function t(t,n,a,o,i,l,r,s){this.mode=t,this.oldText=n.label,this.oldOrigin=n.style.nameOrigin,this.lastOrigin="",this.labelText=n.label,$(l).prop("value",n.label),this.callback=a,this.textRule=o,this.originRule=i,this.radioSelector=r,this.inputSelector=l,this.showSelector=s,this.tappedGobj=n,this.radioPressed=function(t){var n,a,o=this.textRule[t],i=this.tappedGobj;"namedFromLabel"===t&&""===o&&(o=i.label),(t!==i.style.nameOrigin||o!==i.label)&&(n=e(this.mode,t),this.state=new n(this)),"namedFromLabel"===t&&(a=$(this.inputSelector)[0],a.focus(),a.setSelectionRange(0,a.value.length))},this.originFromText=function(e){var t;return""===e?t="noVisibleName":(t=this.originRule[e],t||(t=this.originRule["*"])),t},this.labelChanged=function(t,n){var a=e(this.mode,n);this.labelText=t,this.state instanceof a?this.callback(t,n):this.state=new a(this)},this.state=null}function n(e){this.nameOrigin=e,this.init=function(t,n,a){var o,i=n;this.machine=t,e!==t.lastOrigin&&(i=t.callback(n,e)),$(t.inputSelector).val(i),o=$(this.machine.radioSelector+"[value="+e+"]"),o.prop("checked")||o.prop("checked",!0),i!==n&&(this.machine.labelText=i,delete this.machine.originRule[n],this.machine.originRule[i]=e,this.machine.textRule[e]=i),$(t.showSelector).prop("checked",a),t.lastOrigin=e}}function a(e){this.init(e,"",!0)}function o(e){this.init(e,e.labelText,!0)}function i(e){this.init(e,"",!1)}function l(e){this.init(e,e.textRule.namedByPrime,!0)}function r(e){this.init(e,e.textRule.namedByShortFn,!0)}function s(e){this.init(e,e.textRule.namedByFullFn,!0)}var c;return a.prototype=new n("namedFromTemplate"),a.prototype.constructor=a,o.prototype=new n("namedFromLabel"),o.prototype.constructor=o,i.prototype=new n("noVisibleName"),i.prototype.constructor=i,l.prototype=new n("namedByPrime"),l.prototype.constructor=l,r.prototype=new n("namedByShortFn"),r.prototype.constructor=r,s.prototype=new n("namedByFullFn"),s.prototype.constructor=s,{init:function(n,a,o,i,l,r,s,d){var u=e(n,a.style.nameOrigin);c=new t(n,a,o,i,l,r,s,d),c.state=new u(c),$(".wLabelRadios label").click(function(e){LabelControls.transition(e)})},terminate:function(){c&&(c=null)},transition:function(e){var t=e.target.value||e.target.children[0].value;t&&c.radioPressed(t)},labelChanged:function(e){return c?(c.labelChanged(e,this.originFromText(e)),!0):!1},originFromText:function(e){return c?c.originFromText(e):null}}}(),PAGENUM=function(){function e(e){return $(e).parent().find(".page_buttons")}function t(e){return $(e).data("document")}function n(t){var n=t.canvasNode[0],a=e(n);if(1===a.length)if(t.docSpec.pages.length<2)a.removeClass("page_buttonsActive"),a.empty();else{var o='<span class="page_btn page_prevBtn">&nbsp;</span><div style="display:inline-block; position:relative;"><span class="page_num"></span></div><span class="page_btn page_nextBtn">&nbsp;</span></span>';a.html(o),a.addClass("page_buttonsActive"),a.find(".page_num").on("click",{node:n},function(e){return d(e.data.node),!1}),a.find(".page_prevBtn").on("click",{node:n},function(e){return c(e.data.node,-1,!0),!1}),a.find(".page_nextBtn").on("click",{node:n},function(e){return c(e.data.node,1,!0),!1}),c(n,+t.metadata["start-page"])}}function a(e){var t=e.focusPage.metadata.id,n=$(e.canvasNode).parent().find(".page_popupNum");n.length>0&&($(n).css("background-color","#fff"),$(n[t-1]).css("background-color","#ccc"))}function o(e){var t,n,a,o=e.focusPage;0===o.traces.saturation||o.preferences.fadeTraces||(t=$(e.canvasNode).find(".wsp-clip-node canvas:first-child")[0],n=t.toDataURL(),a=o.metadata.id,e.pageData[a].session.traceData=n)}function i(e,t){var n,a,o,i,l=$(e.canvasNode).find(".wsp-clip-node canvas:first-child")[0],r=e.pageData[t].session,s=r.traceData;s&&(n=l.getContext("2d"),o=l.clientWidth,i=l.clientHeight,a=new Image,a.onload=function(){n.drawImage(a,0,0,a.width,a.height,0,0,o,i)},a.src=s,delete r.traceData)}function l(e,t){var n=$(e).closest(".sketch_container").find(".page_toggle");n.length&&(n.hide(),n.filter(".p_"+t).show())}function r(e,t){var n=e.focusPage.metadata.id,o=e.docSpec.pages.length,r=$(e.canvasNode).parent().find(".page_buttons");f&&i(e,n),r&&(r.find(".page_num").html("&nbsp;"+n+"&nbsp;"),r.find(".page_nextBtn").css("opacity",o>n?"1":"0.4"),r.find(".page_prevBtn").css("opacity",n>1?"1":"0.4"),a(e)),l(t,n)}function s(){var e=$(".sketch_canvas");e.on("LoadDocument.WSP",function(e,t){n(t.document)}),e.on("DidChangeCurrentPage.WSP",function(e,t){r(t.document,e.target)})}function c(e,n,a){var i=t(e),l=+i.focusPage.metadata.id;a&&(n+=l),n>0&&n<=i.docSpec.pages.length&&n!==l&&(f&&!i.focusPage.preferences.fadeTraces&&o(i),
i.switchPage(n))}function d(n){function o(e){return'<span class="page_popupNum">&nbsp;'+e+"&nbsp;</span>"}var i=e(n);if(i.find(".page_popup").length>0)return void u(n);for(var l=t(n),r=l.docSpec.pages.length,s=o(1),d=2;r>=d;d+=1)s+="<br>"+o(d);var f=$.parseHTML('<div class="page_popup" style="line-height:1.1rem;">'+s+"</div>");i.find(".page_num").after(f[0]);var p=$(f).outerHeight()+1;$(f).css({top:-p+"px"}),a(l),i.find(".page_popupNum").on("mouseover",{node:n},function(e){c(e.data.node,this.innerText.trim())}),i.find(".page_popupNum").on("click",{node:n},function(e){return c(e.data.node,this.innerText.trim()),u(e.data.node),!1}),$(window).one("click",{node:n},function(e){return $(e.target).hasClass("page_num")?void 0:(u(e.data.node),!1)}),$(window).off("keydown"),$(window).on("keydown",{node:n},function(e){var t=e.which;return t>=37&&40>=t?(38>=t?c(e.data.node,-1,!0):c(e.data.node,1,!0),!1):void 0})}function u(t){var n=e(t);n.find(".page_popupNum").off("mouseover"),n.find(".page_popupNum").off("click"),n.find(".page_popup").remove(),$(window).off("keydown")}var f=!0;return{initPageControls:function(){s()}}}(),UTILMENU=function(){function e(e){function t(e){r.find(e).show(),c++}var n,a,o,i=PREF.shouldEnable("util","upload",e),l=PREF.shouldEnable("util","download",e),r=$(e.anchorNode).nextAll(".util-menu-btn"),s=i||l,c=0;s?(r.show(),$(r.find(".util-menu-item")).hide(),i&&t(".util-upload"),l&&t(".util-download"),n=r.find(".util-menu-content"),a=.25+1.45*c,o=-a-.4,n.css("height",a+"rem"),n.css("top",o+"rem")):r.hide()}function t(){$(".util-menu-content").hide(),$(window).off("click",n)}function n(e){return $(e.target).hasClass("util-menu")?void 0:(t(),!1)}function a(e,t){var n,a,o,i=e.pageData;if($("#util-fname")[0].validity.valid){".json"!==t.slice(-5)&&(t+=".json");var l=$("#downloadLink")[0];$.each(e.docSpec.pages,function(e,t){var n=t.metadata.id;i[n].session.traceData&&(t.traceData=i[n].session.traceData)}),n=e.sQuery().getSketchJSON(),a=new Blob([n],{type:"text/plain"}),o=URL.createObjectURL(a),l.href=o,l.download=t,l.click(),r(e),UTILMENU.closeModal("download-modal","save")}}function o(){$("#download-modal").css("display","block"),$("#util-fname").select()}function i(e){t(),$("#upload-modal").data("sketchSelector",e),$("#file-name-input").attr("onchange","UTILMENU.loadSketch($('"+e+"'), this.files[0]);")}function l(e){t(),$("#download-modal").data("sketchSelector",e);var n=$("#downloadOK");n.on("click",function(){a($(e).data("document"),$("#util-fname")[0].value)}),$("#util-fname").on("keyup",function(t){var n=$("#util-fname")[0].validity.valid;13===t.keyCode&&n&&a($(e).data("document"),$("#util-fname")[0].value)})}function r(e){var t=e.canvasNode[0].id,n=b64_md5(JSON.stringify(e.getCurrentSpecObject()));$("#"+t).data("prevChecksum",n)}function s(e){var t=$(e).data("document"),n=t.getCurrentSpecObject(),a=b64_md5(JSON.stringify(n)),o=$(e).data("prevChecksum");return a!==o}function c(e){var t,n=e.parents();return $.each(n,function(e,n){var a=$(n).find(".sketch_canvas");return a.length?(t=a[0].id,!1):void 0}),"#"+t}function d(e){function t(e){return e&&e.includes("Times")&&e.includes("sans-serif")&&(e=e.replace("sans-serif","serif")),e}function n(e){var n;for(n=0;n<e.length;++n)e[n]=t(e[n])}function a(e){$.each(e,function(e,n){var a=n["font-family"];a?n["font-family"]=t(a):n.label&&(a=n.label["font-family"],a&&(n.label["font-family"]=t(a)))})}function o(e){n(e.resources.fontList),e.pageData?$.each(e.pageData,function(e,t){a(t.spec.preferences.text.textTypes)}):$.each(e.pages,function(e,t){a(t.preferences.text.textTypes)})}var i=['"Times New Roman", serif','"Arial", sans-serif'];e.resources?e.resources.fontList?o(e):e.resources.fontList=i:e.resources={fontList:i},e.docSpec.resources?e.docSpec.resources.fontList?o(e.docSpec):e.docSpec.resources.fontList=i:e.docSpec.resources={fontList:i},a(e.focusPage.preferences.text.textTypes),r(e)}return{checkFName:function(e){$("#downloadOK").prop("disabled",!e.valid)},closeModal:function(e,t){if($("#"+e).css("display","none"),"download-modal"===e)$("#util-fname").off("keyup"),$("#downloadOK").off("click");else if("upload-modal"===e)switch(t){case"save":o($(this).parents(".util-menu-btn"));break;case"dont-save":$("#file-name-input").click()}},download:function(e){$("#download-modal").data("callSave")&&$("#download-modal").removeData("callSave"),l(e),o()},loadSketch:function(e,t){var n=new FileReader;n.onload=function(n){e.data("sourceDocument",n.target.result),e.data("fileName",t.name.replace(".json","")),e.WSP("loadSketch"),e.removeData("sourceDocument")},n.readAsText(t)},upload:function(e){var t=s(e)&&PREF.shouldEnable("util","download",$(e).data("document").focusPage);i(e),t?(l(e),$("#upload-modal").css("display","block")):$("#file-name-input").click()},menuBtnClicked:function(e){var t=$(e.parentNode).find(".util-menu-content");t.toggle(),"block"===t.css("display")&&$(window).on("click",n)},addUtilMenu:function(e){var t=WIDGETS.getScriptPath(),n='<div class="util-menu-btn util-menu">',a=c(e);return n+='<img class = "util-menu" src="'+t+'utility-icon.png" onclick="UTILMENU.menuBtnClicked(this);" />',n+='<div class="util-menu-content util-menu">',n+='<div class="util-menu-item util-menu util-download" onclick="UTILMENU.download(\''+a+"');\">Download...</div>",n+='<div class="util-menu-item util-menu util-upload" onclick="UTILMENU.upload(\''+a+"');\">Upload...</div>",n+="</div>",n+="</div>",e.replaceWith(n),n},initUtils:function(){var t=$(".sketch_canvas");t.on("DidChangeCurrentPage.WSP",function(t,n){e(n.document.focusPage)}),t.on("LoadDocument.WSP",function(e,t){d(t.document)}),$.each(t,function(e,t){var n=$(t).parent(),a=n.find(".util-menu-btn"),o=$(t).data("document");1!==a.length||a[0].firstElementChild||UTILMENU.addUtilMenu(a),o&&d(o)})}}}();$(function(){WIDGETS.initWidget(),PAGENUM.initPageControls(),UTILMENU.initUtils()});